import{a as se}from"./chunk-T2JSQIUW.js";import{a as Q}from"./chunk-D5ELKAIH.js";import{b as Z,f as $,i as ee,n as te,o as re,p as ie,q as ne,r as oe,y as ae}from"./chunk-4OBXYAWI.js";import{c as J,e as z,h as X,l as U,ma as Y,oa as C,qa as pe,s as K}from"./chunk-F3T4JLSM.js";import{$ as N,Db as j,Ia as L,Ib as q,Ic as F,Nb as a,Ob as s,Tb as k,Xb as R,Yb as B,ca as I,e as l,fb as d,ha as u,ic as p,kb as _,kc as h,mc as W,nc as G,oc as H,qa as x,ra as P,rb as D,tc as S,uc as v,v as c,w as E,wb as M}from"./chunk-RCVRDAM3.js";var le="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var ce=(n=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)e+=le[t[n]&63];return e};var T=class{id=ce();items=[];deliveryMethodId;clientSecret;paymentIntentId;coupon};var f=class n{constructor(e){this.httpClient=e}baseUrl=C.apiUrl;shoppingCart=L(null);itemCount=F(()=>this.shoppingCart()?.items.reduce((e,t)=>e+t.quantity,0));selectedDeliveryMethod=L(null);totals=F(()=>{let e=this.shoppingCart(),t=this.selectedDeliveryMethod();if(e){let r=e.items.reduce((b,g)=>b+g.price*g.quantity,0),i=t?t.price:0,o=0;e.coupon&&(e.coupon.amountOff?o=e.coupon.amountOff:e.coupon.percentOff&&(o=r*(e.coupon.percentOff/100)));let m=r+i-o;return{subtotal:r,shipping:i,discountValue:o,total:m}}else return null});getShoppingCart(e){return this.httpClient.get(this.baseUrl+"shoppingCart?id="+e).pipe(E(t=>(this.shoppingCart.set(t),t)))}setShoppingCart(e){return this.httpClient.post(this.baseUrl+"shoppingCart",e).pipe(N({next:t=>this.shoppingCart.set(t),error:t=>console.log(t)}))}deleteShoppingCart(){this.httpClient.delete(this.baseUrl+"shoppingCart?id="+this.shoppingCart()?.id).subscribe({next:()=>{localStorage.removeItem("shoppingCartId"),this.shoppingCart.set(null)}})}applyDiscount(e){return this.httpClient.get(this.baseUrl+"coupons/"+e)}addItemToShoppingcart(e,t=1){return l(this,null,function*(){let r=this.shoppingCart()??this.createShoppingCart();this.isProduct(e)&&(e=this.mapProductToShoppingCartItem(e)),r.items=this.addOrUpdateItem(r.items,e,t),yield c(this.setShoppingCart(r))})}removeItemFromShoppingCart(e,t=1){return l(this,null,function*(){let r=this.shoppingCart();if(!r){console.log("No shopping cart found");return}let i=r.items.findIndex(o=>o.productId===e);i!==-1?(r.items[i].quantity>t?r.items[i].quantity-=t:r.items.splice(i,1),r.items.length===0?this.deleteShoppingCart():yield c(this.setShoppingCart(r))):console.log("Item not found in shopping cart")})}addOrUpdateItem(e,t,r){let i=e.findIndex(o=>o.productId===t.productId);return i===-1?(t.quantity=r,e.push(t)):e[i].quantity+=r,e}mapProductToShoppingCartItem(e){return{productId:e.id,productName:e.name,price:e.price,quantity:0,pictureUrl:e.pictureUrl,brand:e.brand,type:e.type}}isProduct(e){return e.id!==void 0}createShoppingCart(){let e=new T;return localStorage.setItem("shoppingCartId",e.id),e}static \u0275fac=function(t){return new(t||n)(u(U))};static \u0275prov=I({token:n,factory:n.\u0275fac,providedIn:"root"})};var fe="basil",be=function(e){return e===3?"v3":e},ge="https://js.stripe.com",Ee="".concat(ge,"/").concat(fe,"/stripe.js"),Ie=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,xe=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,ue="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Pe=function(e){return Ie.test(e)||xe.test(e)},_e=function(){for(var e=document.querySelectorAll('script[src^="'.concat(ge,'"]')),t=0;t<e.length;t++){var r=e[t];if(Pe(r.src))return r}return null},he=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(Ee).concat(t);var i=document.head||document.body;if(!i)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return i.appendChild(r),r},je=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"7.3.0",startTime:t})},y=null,V=null,O=null,Ue=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},Te=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},Ve=function(e){return y!==null?y:(y=new Promise(function(t,r){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe&&e&&console.warn(ue),window.Stripe){t(window.Stripe);return}try{var i=_e();if(i&&e)console.warn(ue);else if(!i)i=he(e);else if(i&&O!==null&&V!==null){var o;i.removeEventListener("load",O),i.removeEventListener("error",V),(o=i.parentNode)===null||o===void 0||o.removeChild(i),i=he(e)}O=Te(t,r),V=Ue(r),i.addEventListener("load",O),i.addEventListener("error",V)}catch(m){r(m);return}}),y.catch(function(t){return y=null,Promise.reject(t)}))},Oe=function(e,t,r){if(e===null)return null;var i=t[0],o=i.match(/^pk_test/),m=be(e.version),b=fe;o&&m!==b&&console.warn("Stripe.js@".concat(m," was loaded on the page, but @stripe/stripe-js@").concat("7.3.0"," expected Stripe.js@").concat(b,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var g=e.apply(void 0,t);return je(g,r),g},w,Se=!1,ve=function(){return w||(w=Ve(null).catch(function(e){return w=null,Promise.reject(e)}),w)};Promise.resolve().then(function(){return ve()}).catch(function(n){Se||console.warn(n)});var Ce=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];Se=!0;var i=Date.now();return ve().then(function(o){return Oe(o,t,i)})};var A=class n{constructor(e,t,r){this.httpClient=e;this.shoppingCartService=t;this.accountService=r;this.stripePromise=Ce(C.stripePublicKey)}baseUrl=C.apiUrl;stripePromise;elements;addressElement;paymentElement;getStripeInstance(){return this.stripePromise}initializeElements(){return l(this,null,function*(){if(!this.elements){let e=yield this.getStripeInstance();if(e){let t=yield c(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"}})}else throw new Error("Stripe has not been loaded")}return this.elements})}createAddressElement(){return l(this,null,function*(){if(!this.addressElement){let e=yield this.initializeElements();if(e){let t=this.accountService.currentUser(),r={};t&&(r.name=t.firstName+" "+t.lastName),t?.address&&(r.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,country:t.address.country,postal_code:t.address.postalCode});let i={mode:"shipping",defaultValues:r};this.addressElement=e.create("address",i)}else throw new Error("Elements instance has not been loaded")}return this.addressElement})}createConfirmationToken(){return l(this,null,function*(){let e=yield this.getStripeInstance(),t=yield this.initializeElements(),r=yield t.submit();if(r.error)throw new Error(r.error.message);if(e)return yield e.createConfirmationToken({elements:t});throw new Error("Stripe not available in createConfirmationToken")})}confirmPayment(e){return l(this,null,function*(){let t=yield this.getStripeInstance(),i=yield(yield this.initializeElements()).submit();if(i.error)throw new Error(i.error.message);let o=this.shoppingCartService.shoppingCart()?.clientSecret;if(console.log("Client secret in confirmPayment: "+o),t&&o)return yield t.confirmPayment({clientSecret:o,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Stripe not available in confirmPayment")})}createOrUpdatePaymentIntent(){let e=this.shoppingCartService.shoppingCart(),t=!!e?.clientSecret;if(console.log("Client secret in createOrUpdatePaymentIntent: "+e?.clientSecret),!e)throw new Error("Problem with shopping cart");return this.httpClient.post(this.baseUrl+"payments/"+e.id,{}).pipe(E(r=>l(this,null,function*(){return t&&(yield c(this.shoppingCartService.setShoppingCart(r))),r})))}createPaymentElement(){return l(this,null,function*(){if(!this.paymentElement){let e=yield this.initializeElements();if(e)this.paymentElement=e.create("payment");else throw new Error("Elements instance has not been loaded")}return this.paymentElement})}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}static \u0275fac=function(t){return new(t||n)(u(U),u(f),u(pe))};static \u0275prov=I({token:n,factory:n.\u0275fac,providedIn:"root"})};function Le(n,e){n&1&&(a(0,"div",11)(1,"button",19),p(2,"Checkout"),s(),a(3,"button",20),p(4,"Continue Shopping"),s()())}function Me(n,e){if(n&1){let t=k();a(0,"div",21)(1,"span",22),p(2),s(),a(3,"button",23),R("click",function(){x(t);let i=B();return P(i.removeCouponCode())}),a(4,"mat-icon",24),p(5,"delete"),s()()()}if(n&2){let t=e.ngIf;d(2),h("",t.name," applied")}}var ye=class n{constructor(e,t,r){this.shoppingCartService=e;this.location=t;this.stripeService=r}code;get locationPath(){return this.location.path()}get subtotal(){return this.shoppingCartService.totals()?.subtotal}get discount(){return this.shoppingCartService.totals()?.discountValue}get shipping(){return this.shoppingCartService.totals()?.shipping}get total(){return this.shoppingCartService.totals()?.total}get coupon(){return this.shoppingCartService.shoppingCart()?.coupon}removeCouponCode(){return l(this,null,function*(){let e=this.shoppingCartService.shoppingCart();e&&(e.coupon&&(e.coupon=void 0),yield c(this.shoppingCartService.setShoppingCart(e)),this.location.path()==="/checkout"&&(yield c(this.stripeService.createOrUpdatePaymentIntent())))})}applyCouponCode(){console.log("Coupon code: "+this.code),this.code&&this.shoppingCartService.applyDiscount(this.code).subscribe({next:e=>l(this,null,function*(){let t=this.shoppingCartService.shoppingCart();t&&(t.coupon=e,yield c(this.shoppingCartService.setShoppingCart(t)),this.code=void 0,this.location.path()==="/checkout"&&(yield c(this.stripeService.createOrUpdatePaymentIntent())))})})}static \u0275fac=function(t){return new(t||n)(_(f),_(J),_(A))};static \u0275cmp=D({type:n,selectors:[["app-order-summary"]],decls:43,vars:17,consts:[["form","ngForm"],[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","border-gray-200","p-4","bg-white","shadow-sm"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium","text-gray-500"],[1,"font-medium","text-gray-900"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-t","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white","shadow-sm"],[1,"space-y-2","flex","flex-col","p-2",3,"ngSubmit"],[1,"mb-2","block","text-sm","font-mediem"],["class","flex justify-between items-center",4,"ngIf"],["appearance","outline"],["name","code","type","text","matInput","",3,"ngModelChange","disabled","ngModel"],["type","submit","mat-flat-button","",3,"disabled"],["routerLink","/checkout","mat-flat-button",""],["routerLink","/shop","mat-button",""],[1,"flex","justify-between","items-center"],[1,"text-sm","font-semibold"],["mat-icon-button","",3,"click"],["color","warn"]],template:function(t,r){if(t&1){let i=k();a(0,"div",1)(1,"div",2)(2,"p",3),p(3,"Order summary"),s(),a(4,"div",4)(5,"div",5)(6,"dl",6)(7,"dt",7),p(8,"Subtotal"),s(),a(9,"dd",8),p(10),S(11,"currency"),s()(),a(12,"dl",6)(13,"dt",7),p(14,"Discount"),s(),a(15,"dd",9),p(16),S(17,"currency"),s()(),a(18,"dl",6)(19,"dt",7),p(20,"Delivery fee"),s(),a(21,"dd",8),p(22),S(23,"currency"),s()()(),a(24,"dl",10)(25,"dt",7),p(26,"Total"),s(),a(27,"dd",8),p(28),S(29,"currency"),s()()(),M(30,Le,5,0,"div",11),s(),a(31,"div",12)(32,"form",13,0),R("ngSubmit",function(){return x(i),P(r.applyCouponCode())}),a(34,"label",14),p(35," Do you have a voucher code? "),s(),M(36,Me,6,1,"div",15),a(37,"mat-form-field",16)(38,"mat-label"),p(39,"Voucher code"),s(),a(40,"input",17),H("ngModelChange",function(m){return x(i),G(r.code,m)||(r.code=m),P(m)}),s()(),a(41,"button",18),p(42,"Apply code "),s()()()()}t&2&&(d(10),h(" ",v(11,9,r.subtotal)," "),d(6),h(" -",v(17,11,r.discount)," "),d(6),h(" ",v(23,13,r.shipping)," "),d(6),h(" ",v(29,15,r.total)," "),d(2),q(r.locationPath!=="/checkout"?30:-1),d(6),j("ngIf",r.coupon),d(4),j("disabled",!!r.coupon),W("ngModel",r.code),d(),j("disabled",!!r.coupon))},dependencies:[K,Y,$,Z,se,Q,ae,oe,ee,te,re,ne,ie,X,z],encapsulation:2})};export{f as a,A as b,ye as c};
